name: Compare Documentation

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'check_docs.py'
  workflow_dispatch:
    inputs:
      working-directory:
        description: 'The directory containing the charm and its docs folder.'
        required: true
        default: '.'

jobs:
  compare-docs:
    name: Compare Documentation
    runs-on: ubuntu-24.04
    
    defaults:
      run:
        working-directory: ${{ github.event.inputs.working-directory || '.' }}

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests PyYAML
          pip install markdown-analysis 

      - name: Check if 'docs' directory exists
        id: docs-check
        run: |
          if [[ -d "docs" ]]; then
            echo "exists=true"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run documentation check
        if: steps.docs-check.outputs.exists == 'true'
        env:
          DISCOURSE_URL: https://discourse.charmhub.io
        run: |
          echo "Running documentation format check..."
          python check_docs.py

      - name: Comment on PR if changes needed
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“‹ Documentation format check failed. Please review the documentation format and ensure it matches the expected structure.'
            })